#!/bin/bash
# å…¨å±€ Git Pre-commit Hook
# åŠŸèƒ½ï¼šæ£€æŸ¥æ•æ„Ÿä¿¡æ¯ã€æ¸…ç†è°ƒè¯•æ—¥å¿—

echo "ğŸ” è¿è¡Œ pre-commit æ£€æŸ¥..."

# 1. æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
SENSITIVE_FILES=".env .env.local .env.production credentials.json secrets.json config/secrets.yml"
for file in $SENSITIVE_FILES; do
  if git diff --cached --name-only | grep -q "^$file$"; then
    echo "âŒ é”™è¯¯ï¼šå°è¯•æäº¤æ•æ„Ÿæ–‡ä»¶ $file"
    echo "   è¯·å°†å…¶æ·»åŠ åˆ° .gitignore"
    exit 1
  fi
done

# 2. æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿå…³é”®è¯
if git diff --cached | grep -iE "(password|secret|api_key|private_key|token).*=.*['\"].*['\"]"; then
  echo "âš ï¸  è­¦å‘Šï¼šæ£€æµ‹åˆ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç /å¯†é’¥/tokenï¼‰"
  echo "   è¯·ç¡®è®¤æ˜¯å¦ä¸ºæµ‹è¯•æ•°æ®ï¼Œå¦‚æœæ˜¯çœŸå®å¯†é’¥è¯·ç§»é™¤"
  read -p "   ç¡®è®¤ç»§ç»­æäº¤ï¼Ÿ(y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# 3. æ£€æŸ¥è°ƒè¯•æ—¥å¿—ï¼ˆPythonï¼‰
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')
if [ -n "$PYTHON_FILES" ]; then
  for file in $PYTHON_FILES; do
    if grep -n "print(" "$file" | grep -v "# keep" | grep -v "#keep"; then
      echo "âš ï¸  è­¦å‘Šï¼š$file åŒ…å« print() è°ƒè¯•è¯­å¥"
      echo "   å»ºè®®ç§»é™¤æˆ–æ·»åŠ  # keep æ³¨é‡Šä¿ç•™"
    fi
  done
fi

# 4. æ£€æŸ¥è°ƒè¯•æ—¥å¿—ï¼ˆJavaScript/TypeScriptï¼‰
JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$')
if [ -n "$JS_FILES" ]; then
  for file in $JS_FILES; do
    if grep -n "console\.\(log\|debug\|info\)" "$file" | grep -v "// keep" | grep -v "//keep"; then
      echo "âš ï¸  è­¦å‘Šï¼š$file åŒ…å« console.log/debug/info è°ƒè¯•è¯­å¥"
      echo "   å»ºè®®ç§»é™¤æˆ–æ·»åŠ  // keep æ³¨é‡Šä¿ç•™"
    fi
  done
fi

echo "âœ… Pre-commit æ£€æŸ¥å®Œæˆ"
exit 0
